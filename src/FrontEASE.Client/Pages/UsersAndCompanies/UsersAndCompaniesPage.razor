@inject IResourceHandler resourceHandler
@inject IUIService uiService

@attribute [Authorize(Roles = $"{UserRoleNames.AdminRoleName}, {UserRoleNames.SuperadminRoleName}")]
@page "/Users"

<PageTitle>
    @(resourceHandler.GetResource($"{UIConstants.Base}.{UIConstants.Specific}.{UIElementConstants.Page}.{UIPageConstants.UsersAndCompanies}"))
</PageTitle>

<Container Fluid Class="content-main" Padding="Padding.Is5.FromStart.Is5.FromEnd">
    <Row>
        <Column ColumnSize="ColumnSize.Is12" TextAlignment="TextAlignment.Center" Padding="Padding.Is0">
            <Tabs RenderMode="TabsRenderMode.LazyReload"
                  SelectedTab="@managementTypeSelected.ToString()"
                  SelectedTabChanged="@OnSelectedTabChanged"
                  Class="tab-control"
                  Border="Border.Is0">
                <Items>
                    @foreach (var managementType in Enum.GetValues(typeof(UserCompanyManagementType)))
                    {
                        @switch (managementType)
                        {
                            case UserCompanyManagementType.COMPANIES:
                                <AuthorizeView Roles="@($"{UserRoleNames.SuperadminRoleName}")">
                                    <Tab Name="@(managementType.ToString())">
                                        @(resourceHandler.GetResource(((UserCompanyManagementType)managementType).GetEnumResourceValue()))
                                    </Tab>
                                </AuthorizeView>
                                break;
                            default:
                                <Tab Name="@(managementType.ToString())">
                                    @(resourceHandler.GetResource(((UserCompanyManagementType)managementType).GetEnumResourceValue()))
                                </Tab>
                                break;
                        }
                    }
                </Items>
                <Content>
                    @foreach (var personType in Enum.GetValues(typeof(UserCompanyManagementType)))
                    {
                        <CascadingValue Value="PageContext">
                            <TabPanel TextAlignment="TextAlignment.Start" Name="@(personType.ToString())">
                                @switch (managementTypeSelected)
                                {
                                    case UserCompanyManagementType.USERS:
                                        <UserManagementTab />
                                        break;
                                    case UserCompanyManagementType.COMPANIES:
                                        <AuthorizeView Roles="@($"{UserRoleNames.SuperadminRoleName}")">
                                            <CompanyManagementTab />
                                        </AuthorizeView>
                                        break;
                                }
                            </TabPanel>
                        </CascadingValue>
                    }
                </Content>
            </Tabs>

        </Column>
    </Row>
</Container>

@code {
    [CascadingParameter]
    public ApplicationContext ApplicationContext { get; set; } = new();

    private UsersAndCompaniesPageContext PageContext = null!;
    private UserCompanyManagementType managementTypeSelected = UserCompanyManagementType.USERS;

    private async Task RefreshViewAsync() => await InvokeAsync(StateHasChanged);

    protected override async Task OnInitializedAsync()
    {
        PageContext = new UsersAndCompaniesPageContext(ApplicationContext);
        uiService.RefreshRequested += RefreshViewAsync;
        await base.OnInitializedAsync();
    }

    private void OnSelectedTabChanged(string name) => managementTypeSelected = (UserCompanyManagementType)Enum.Parse(typeof(UserCompanyManagementType), name);
}