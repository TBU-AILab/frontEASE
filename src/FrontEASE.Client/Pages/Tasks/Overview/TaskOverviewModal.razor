@inject IMapper mapper
@inject IUIService uiService
@inject ITaskApiService taskApiService
@inject IResourceHandler resourceHandler
@inject AppSettings appSettings

<Modal @ref="@TaskModalContext.Modal" Closing="@(async (e) => await OnModalClosing(e))" @bind-Visible="@isModalVisible" Class="modal-dialog-extrawide" Border="Border.Rounded" @onkeydown="@(async (e) => await HandleKeyDown(e))">
    @if (isModalVisible)
    {
        @if (TaskModalContext.TaskMetadata.ReloadInProgress)
        {
            <BackgroundLoadSpinner TextColor="TextColor.White" TextSize="TextSize.Large" />
        }

        <ModalContent Centered Shadow="Shadow.Small">
            @if (isTaskLoading)
            {
                <ContentLoadSpinner />
            }
            else
            {
                <GenericModalHeader DisplayText="@($"{resourceHandler.GetResource($"{UIConstants.Base}.{UIConstants.Generic}.{UIActionConstants.Overview}")} - {TaskModalContext.Task.Config.Name}")" />

                <ModalBody Padding="Padding.Is0" Class="bg-custom-primary text-custom-primary">
                    <Container Fluid Height="Height.Is100">
                        <Row Height="Height.Is100">
                            <Column ColumnSize="ColumnSize.Is3.OnWidescreen" TextAlignment="TextAlignment.Start" Class="overview-dialog-column" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnEnd">
                                <TaskSubitemsDataViewSection TaskModalContext="TaskModalContext" />
                            </Column>
                            <Column ColumnSize="ColumnSize.Is6.OnWidescreen" Class="overview-dialog-column" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnStart.Is1.OnEnd">
                                <TaskMessagesViewSection TaskModalContext="TaskModalContext" />
                            </Column>
                            <Column ColumnSize="ColumnSize.Is3.OnWidescreen" TextAlignment="TextAlignment.Start" Class="overview-dialog-column" Height="Height.Is100" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnStart">
                                <TaskInfoDataViewSection TaskModalContext="TaskModalContext" />
                            </Column>
                        </Row>

                    </Container>
                </ModalBody>

                <TaskOverviewModalFooter TaskModalContext="TaskModalContext" @ref="@TaskOverviewModalFooter" />
            }
        </ModalContent>
    }

</Modal>

@code {
    [Parameter]
    public TaskInfoDto TaskInfo { get; set; } = new();

    [Parameter]
    public DataOperation Operation { get; set; }

    private bool isTaskLoading;
    private bool isModalVisible;

    private TaskModalContext TaskModalContext;
    private TaskOverviewModalFooter TaskOverviewModalFooter = new();
    private CancellationTokenSource? cancellationTokenSource;

    public TaskOverviewModal()
    {
        TaskModalContext = new TaskModalContext(new(), TaskInfo, new(), new(), Operation, new());
    }

    private async Task HandleKeyDown(KeyboardEventArgs e) => await TaskOverviewModalFooter.HandleKeyDown(e);

    private async Task ResetCancellationToken()
    {
        if (cancellationTokenSource is not null)
        {
            await cancellationTokenSource.CancelAsync();
            cancellationTokenSource.Dispose();
        }
        cancellationTokenSource = new();
    }

    private async Task OnModalClosing(ModalClosingEventArgs e)
    {
        await ResetCancellationToken();

        TaskModalContext.TaskMetadata.SelectedMessageID = null;
        isModalVisible = false;
    }

    private async Task ShowModal()
    {
        isModalVisible = true;
        await TaskModalContext.Modal.Show();
    }

    private async Task HideModal()
    {
        isModalVisible = false;
        await TaskModalContext.Modal.Hide();
    }

    public async Task Show()
    {
        isTaskLoading = true;
        await ResetCancellationToken();
        await ShowModal();

        var opened = await taskApiService.LoadTask(TaskInfo.ID, false);
        if (opened is not null)
        {
            mapper.Map(opened, TaskModalContext.Task);
        }

        _ = StartPeriodicTaskInfoRefreshCall(cancellationTokenSource!.Token);
        isTaskLoading = false;
    }


    private async Task StartPeriodicTaskInfoRefreshCall(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                if (TaskModalContext.Task.State == TaskState.RUN)
                {
                    TaskModalContext.TaskMetadata.ReloadInProgress = true;
                    await uiService.CallRequestRefreshAsync();

                    var taskInfoNew = await taskApiService.LoadTask(TaskInfo.ID, false);
                    if (taskInfoNew is not null)
                    {
                        mapper.Map(taskInfoNew, TaskModalContext.Task);
                    }

                    TaskModalContext.TaskMetadata.ReloadInProgress = false;
                    await uiService.CallRequestRefreshAsync();
                }
                await System.Threading.Tasks.Task.Delay(TimeSpan.FromSeconds(appSettings.PageSettings!.Tasks!.Timers!.SingleTaskStateRefetchIntervalSeconds), cancellationToken);
            }
        }
        catch (Exception ex)
        {
            await Console.Out.WriteLineAsync(ex.Message);
        }
    }
}