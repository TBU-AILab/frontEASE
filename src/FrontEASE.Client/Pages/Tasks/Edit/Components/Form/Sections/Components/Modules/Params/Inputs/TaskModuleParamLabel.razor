@inject IUIService uiService
@inject IResourceHandler resourceHandler﻿
@inject ITaskManipulationService taskManipulationService

<Field ColumnSize="@(HasDescription? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
    <Span TextSize="TextSize.Small" TextColor="TextColor.Info">
        @($"[{resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.Readonly}")}]")
    </Span>
    <Label For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))">
        @($"{TaskModuleParamContext.ParamName}")
    </Label>

    <Div>
        @if (TaskModuleParamContext.ParamType is not null)
        {
            var notAvailableResource = resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.NotAvailable}");
            switch (TaskModuleParamContext.ParamType)
            {
                case ParameterType.STR:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @(TaskModuleParamContext.ParamOption.Default?.StringValue ?? notAvailableResource)
                    </Label>
                    break;

                case ParameterType.INT:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @(TaskModuleParamContext.ParamOption.Default?.IntValue?.ToString() ?? notAvailableResource)
                    </Label>
                    break;

                case ParameterType.FLOAT:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @(TaskModuleParamContext.ParamOption.Default?.FloatValue?.ToString() ?? notAvailableResource)
                    </Label>
                    break;

                case ParameterType.TIME:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @($"{ParameterTimeHelper.FormatTimeValueForDisplay(TaskModuleParamContext.ParamOption.Default?.IntValue, resourceHandler)}")
                    </Label>
                    break;

                case ParameterType.BOOL:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @(TaskModuleParamContext.ParamOption.Default?.BoolValue?.ToString() ?? notAvailableResource)
                    </Label>
                    break;

                case ParameterType.MARKDOWN:
                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                        @((MarkupString)Markdig.Markdown.ToHtml(TaskModuleParamContext.ParamOption.Default?.StringValue?.ToString() ?? notAvailableResource))
                    </Label>
                    break;

                case ParameterType.LIST:
                    foreach (var listParam in TaskModuleParamContext.ParamOption.Default!.ListValue!.ParameterValues)
                    {
                        foreach (var listParamItem in listParam.ParameterItems)
                        {
                            var context = taskManipulationService.GetListParamContext(listParamItem);
                            <TaskModuleParamLabel TaskModalContext="TaskModalContext" TaskModuleParamContext="context" />
                        }
                    }

                    break;

                case ParameterType.ENUM:
                    @if (TaskModuleParamContext.ParamOption.EnumOptions?.Count > 0 == true)
                    {
                        <UnorderedList>
                            @foreach (var (enumOption, index) in TaskModuleParamContext.ParamOption.EnumOptions.Select((option, idx) => (option, idx)))
                            {
                                var displayName = TaskModuleParamContext.ParamOption.EnumLongNames?.ElementAtOrDefault(index) ?? enumOption.StringValue;
                                var description = TaskModuleParamContext.ParamOption.EnumDescriptions?.ElementAtOrDefault(index);

                                <UnorderedListItem>
                                    <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                                        @($"{displayName}{(string.IsNullOrEmpty(description) ? string.Empty : $" ({description})")}")
                                    </Label>
                                </UnorderedListItem>
                            }
                        </UnorderedList>
                    }
                    else
                    {
                        <Label TextWeight="TextWeight.Normal" Class="fst-italic">
                            @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.NoValue}"))
                        </Label>
                    }

                    @if (TaskModuleParamContext.ParamOption.Default?.EnumValue is not null)
                    {
                        <Label TextWeight="TextWeight.Normal">
                            @(TaskModuleParamContext.ParamOption.Default?.EnumValue?.StringValue ?? notAvailableResource)
                        </Label>
                    }
                    break;

                default:
                    <Label TextWeight="TextWeight.Normal">
                        @notAvailableResource
                    </Label>
                    break;

            }

        }
    </Div>
</Field>

@{
    var isParamSpecialCase = IsSpecialCase();
}
@if (HasDescription || isParamSpecialCase)
{
    <Field ColumnSize="ColumnSize.Is2.OnWidescreen.Is1.OnFullHD" TextAlignment="TextAlignment.Center" Class="align-self-center" Padding="Padding.Is0.FromEnd.Is0.FromStart" Margin="Margin.Is2.FromTop">
        <FieldLabel>
            @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{(isParamSpecialCase ? UIValueConstants.Actions : UIValueConstants.Info)}"))
        </FieldLabel>
        <Div>
            <Tooltip Multiline="true" Text="@(TaskModuleParamContext.ParamOption.Description)" Display="Display.InlineBlock" Padding="Padding.Is1.FromEnd" Placement="TooltipPlacement.Top">
                <Icon Class="action-icon-sm action-icon-info" Name="IconName.InfoCircle" IconSize="IconSize.Default" IconStyle="IconStyle.Solid" />
            </Tooltip>
            @if (isParamSpecialCase)
            {
                @if (TaskModuleParamContext.ParamOption.ShortName == TaskMetadataConstants.InitMessageTemplate && !string.IsNullOrEmpty(TaskModuleParamContext.ParamOption.Default?.StringValue))
                {
                    <Tooltip Multiline="true" Text="@($"{resourceHandler.GetResource($"{UIConstants.Base}.{UIConstants.Generic}.{UIActionConstants.Use}.{UIStateConstants.Default}")} : \"{TaskModuleParamContext.ParamOption.Default?.StringValue}\"")" Display="Display.InlineBlock" Padding="Padding.Is1.FromEnd">
                        <Icon Class="action-icon-sm action-icon-success" Name="IconName.Paste" IconSize="IconSize.Default" IconStyle="IconStyle.Solid" Clicked="(async () => await FillInitMessageValue())" />
                    </Tooltip>
                }
            }
        </Div>
    </Field>
}

@code {
    [Parameter]
    public TaskModalContext TaskModalContext { get; set; } = null!;

    [Parameter]
    public TaskModuleParamContext TaskModuleParamContext { get; set; } = null!;

    private Guid ParameterID = Guid.NewGuid();

    private bool HasDescription => !string.IsNullOrWhiteSpace(TaskModuleParamContext.ParamOption.Description);
    private bool IsSpecialCase() => TaskModuleParamContext.ParamOption.ShortName == TaskMetadataConstants.InitMessageTemplate;

    private async Task FillInitMessageValue()
    {
        TaskModalContext.Task.Config.InitialMessage = TaskModuleParamContext.ParamOption.Default?.StringValue ?? string.Empty;
        await uiService.CallRequestRefreshAsync();
    }

    private string GetElementIdByOperation(string elementBase) => VisualisationHelper.GetElementIdByOperation<TaskModuleParameterDto>(elementBase, TaskModalContext.Operation, $"{TaskModalContext.Task.ID.ToString()}_{TaskModuleParamContext.ParamID.ToString()}");
}