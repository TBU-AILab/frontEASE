@inject IResourceHandler resourceHandler
@inject ITaskManipulationService taskManipulationService
@inject IUIService uiService
@inject IMapper mapper

@if (TaskModuleParamContext is not null)
{
    TaskModuleParamContext.ParamFlags = taskManipulationService.GetParamFlags(TaskModuleContext.Module, TaskModuleParamContext.ParamOption, TaskModuleParamContext.ParamValue!);
}

@if (TaskModuleParamContext?.ParamFlags?.ParamType is not null)
{
    @if (TaskModuleParamContext.ParamFlags.IsTokenSelector)
    {
        <TaskModuleParamValueTokenSelector TaskModalContext="TaskModalContext" TaskModuleContext="TaskModuleContext" TaskModuleParamContext="TaskModuleParamContext" />
    }
    else if (TaskModuleParamContext.ParamFlags.IsListParam)
    {
        <TaskModuleListParamLabel TaskModalContext="TaskModalContext" TaskModuleParamContext="TaskModuleParamContext" />
        <TaskModuleListParamValue TaskModalContext="TaskModalContext" TaskModuleParamContext="TaskModuleParamContext" />
    }
    else
    {
        <TaskModuleParamValueInput TaskModalContext="TaskModalContext" TaskModuleContext="TaskModuleContext" TaskModuleParamContext="TaskModuleParamContext" />
    }
}

@if (TaskModuleParamContext?.ParamFlags?.DisplayActions == true)
{
    <Field ColumnSize="ColumnSize.Is2.OnWidescreen.Is1.OnFullHD" TextAlignment="TextAlignment.Center" Class="align-self-center" Padding="Padding.Is0.FromEnd.Is0.FromStart" Margin="Margin.Is2.FromTop">
        <FieldLabel>
            @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.Actions}"))
        </FieldLabel>
        <Div>
            @if (TaskModuleParamContext.ParamFlags!.IsDescriptionPresent)
            {
                <Tooltip Multiline="true" Text="@(TaskModuleParamContext.ParamOption!.Description ?? TaskModuleParamContext.ParamFlags!.InternalDescription)" Display="Display.InlineBlock" Padding="Padding.Is1.FromEnd" Placement="TooltipPlacement.Top">
                    <Icon Class="action-icon-sm action-icon-info" Name="IconName.InfoCircle" IconSize="IconSize.Default" IconStyle="IconStyle.Solid" />
                </Tooltip>
            }
            @if (TaskModuleParamContext.ParamFlags!.IsDefaultPresent && !TaskModalContext.TaskMetadata.InitializationInProgres)
            {
                <Tooltip Multiline="true" Text="@($"{resourceHandler.GetResource($"{UIConstants.Base}.{UIConstants.Generic}.{UIActionConstants.Use}.{UIStateConstants.Default}")} : \"{TaskModuleParamContext.ParamFlags.ParamDefaultValue}\"")" Display="Display.InlineBlock" Padding="Padding.Is1.FromEnd">
                    <Icon Class="action-icon-sm action-icon-success" Name="IconName.Paste" IconSize="IconSize.Default" IconStyle="IconStyle.Solid" Clicked="(() => taskManipulationService.FillParamDefaultValue(TaskModuleParamContext.ParamValue!, TaskModuleParamContext.ParamFlags.ParamDefaultValue))" />
                </Tooltip>
            }
        </Div>
    </Field>
}

@if (TaskModuleParamContext?.ParamFlags?.ParamType == ParameterType.MARKDOWN)
{
    <Validation>
        <Field ColumnSize="@(TaskModuleParamContext.ParamFlags!.DisplayActions ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)" Class="input-validation-only">

            <MemoEdit ElementId="@(GetElementIdByOperation($"{TaskModuleParamContext.ParamOption.Key}{nameof(Blazorise.Markdown.Markdown)}"))"
                      Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                      @bind-Text="@TaskModuleParamContext.ParamValue!.Value!.StringValue"
                      Placeholder="@(TaskModuleParamContext.ParamOption.Default?.StringValue ?? TaskModuleParamContext.ParamOption.LongName ?? string.Empty)">
                <Feedback>
                    <ValidationError Multiline="true" />
                </Feedback>
            </MemoEdit>
        </Field>
    </Validation>
}

@code {
    [Parameter]
    public TaskModalContext TaskModalContext { get; set; } = null!;

    [Parameter]
    public TaskModuleContext TaskModuleContext { get; set; } = null!;

    [Parameter]
    public TaskModuleParamContext TaskModuleParamContext { get; set; } = null!;

    private async Task RefreshViewAsync()
    {
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        uiService.RefreshRequested += RefreshViewAsync;
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        var derivedFlags = taskManipulationService.GetParamFlags(TaskModuleContext.Module, TaskModuleParamContext.ParamOption, TaskModuleParamContext.ParamValue!);
        mapper.Map(derivedFlags, TaskModuleParamContext.ParamFlags);
    }

    private string GetElementIdByOperation(string elementBase) => VisualisationHelper.GetElementIdByOperation<TaskModuleParameterDto>(elementBase, TaskModalContext.Operation, $"{TaskModalContext.Task.ID.ToString()}_{TaskModuleParamContext.ParamID.ToString()}");
}