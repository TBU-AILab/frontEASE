@inject ITaskManipulationService taskManipulationService
@inject IResourceHandler resourceHandler
@inject IMapper mapper
@inject IUIService uiService

@switch (TaskModuleParamContext.ParamType)
{
    case ParameterType.MARKDOWN:
        <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
            @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
            {
                <FieldLabel For="@(GetElementIdByOperation($"{TaskModuleParamContext.ParamOption.Key}{nameof(Blazorise.Markdown.Markdown)}"))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                    @TaskModuleParamContext.ParamName
                </FieldLabel>
            }

            @if (!TaskModalContext.TaskMetadata.InitializationInProgres)
            {
                <Markdown UploadImage="false"
                          NativeSpellcheck="false"
                          SpellChecker="false"
                          @bind-Value="@TaskModuleParamContext.ParamValue!.Value!.StringValue"
                          Placeholder="@(TaskModuleParamContext.ParamOption.Default?.StringValue ?? TaskModuleParamContext.ParamOption.LongName ?? string.Empty)" />
            }
        </Field>
        break;


    case ParameterType.STR:
        <Validation>
            <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                {
                    <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamValue!.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                        @TaskModuleParamContext.ParamName
                    </FieldLabel>
                }

                <MemoEdit ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                          Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                          @bind-Text="@TaskModuleParamContext.ParamValue!.Value!.StringValue"
                          Placeholder="@(TaskModuleParamContext.ParamOption.Default?.StringValue ?? TaskModuleParamContext.ParamOption.LongName ?? string.Empty)"
                          Rows="2" AutoSize="true">
                    <Feedback>
                        <ValidationError Multiline="true" />
                    </Feedback>
                </MemoEdit>
            </Field>
        </Validation>
        break;

    case ParameterType.INT:
        <Validation>
            <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                {
                    <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                        @TaskModuleParamContext.ParamName
                    </FieldLabel>
                }

                <NumericEdit TValue="int?"
                             ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                             Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                             @bind-Value="@TaskModuleParamContext.ParamValue!.Value!.IntValue"
                             Placeholder="@(TaskModuleParamContext.ParamOption.Default?.IntValue?.ToString() ?? 0.ToString())"
                             Min="@(TaskModuleParamContext.ParamOption.MinValue is double intMin ? (int)intMin : int.MinValue)"
                             Max="@(TaskModuleParamContext.ParamOption.MaxValue is double intMax ? (int)intMax : int.MaxValue)">
                    <Feedback>
                        <ValidationError Multiline="true" />
                    </Feedback>
                </NumericEdit>
            </Field>
        </Validation>
        break;


    case ParameterType.TIME:
        <Validation @ref="timeValidationComponent" Validator="@ValidateTimeParameter">
            <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                {
                    <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                        @TaskModuleParamContext.ParamName
                    </FieldLabel>
                }
                <InputMask @ref="timeInputMask"
                           ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                           Mask="99:99:99"
                           MaskPlaceholder="_"
                           Placeholder="@GetTimeInputPlaceholder()"
                           Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                           Value="@timeStringValue"
                           ValueChanged="@(async (e) => await OnTimeStringChanged(e))"
                           ClearIncomplete="true"
                           ShowMaskOnFocus="true" />

                <ValidationError Multiline="true" />
            </Field>
        </Validation>
        break;

    case ParameterType.FLOAT:
        <Validation>
            <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                {
                    <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                        @TaskModuleParamContext.ParamName
                    </FieldLabel>
                }

                <NumericEdit TValue="double?"
                             ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                             Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                             @bind-Value="@TaskModuleParamContext.ParamValue!.Value!.FloatValue"
                             Placeholder="@(TaskModuleParamContext.ParamOption.Default?.FloatValue?.ToString() ?? 0.0.ToString())"
                             Min="@(TaskModuleParamContext.ParamOption.MinValue is double floatMin ? floatMin : double.MinValue)"
                             Max="@(TaskModuleParamContext.ParamOption.MaxValue is double floatMax ? floatMax : double.MaxValue)">
                    <Feedback>
                        <ValidationError Multiline="true" />
                    </Feedback>
                </NumericEdit>
            </Field>
        </Validation>
        break;

    case ParameterType.ENUM:
        @if (!string.IsNullOrWhiteSpace(TaskModuleParamContext.ParamOption.EnumOptions?.FirstOrDefault()?.StringValue))
        {
            <Validation>
                <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                    @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                    {
                        <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                            @TaskModuleParamContext.ParamName
                        </FieldLabel>
                    }

                    <Select TValue="string"
                            Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                            ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                            SelectedValue="@TaskModuleParamContext.ParamValue!.Value!.EnumValue!.StringValue"
                            SelectedValueExpression="@(() => TaskModuleParamContext.ParamValue.Value!.EnumValue!.StringValue)"
                            SelectedValueChanged="@(async (value) => await OnStringEnumValueChanged(value))">
                        <ChildContent>
                            <SelectItem Value="string.Empty">
                                @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.Empty}"))
                            </SelectItem>
                            @foreach (var enumOption in TaskModuleParamContext.ParamOption.EnumOptions)
                            {
                                var longName = (string?)null;
                                var longNameIndex = TaskModuleParamContext.ParamOption.EnumOptions.Select(x => x.StringValue).ToList().FindIndex(x => x == enumOption.StringValue);
                                @if (TaskModuleParamContext.ParamOption.EnumLongNames?.Count > 0)
                                {
                                    longName = TaskModuleParamContext.ParamOption.EnumLongNames?.ElementAtOrDefault(longNameIndex);
                                }

                                <SelectItem Value="@(enumOption.StringValue)">
                                    @(longName ?? enumOption.StringValue)
                                </SelectItem>
                            }
                        </ChildContent>
                        <Feedback>
                            <ValidationError Multiline="true" />
                        </Feedback>
                    </Select>
                </Field>
            </Validation>
        }
        else if (TaskModuleParamContext.ParamOption.EnumOptions?.FirstOrDefault()?.ModuleValue is not null)
        {
            var moduleType = TaskModuleParamContext.ParamOption.EnumOptions.Select(x => x.ModuleValue?.PackageType).FirstOrDefault(x => x.HasValue);
            if (moduleType is not null)
            {
                var moduleContext = new TaskModuleContext(
                    TaskModuleParamContext.ParamValue!.Value!.EnumValue!.ModuleValue!,
                    TaskModuleParamContext.ParamOption!.EnumOptions.Select(x => x.ModuleValue!).ToList(),
                    TaskModuleParamContext.ParamName);

                TaskModuleParamContext.ParamValue.Value!.EnumValue!.ModuleValue ??= new() { PackageType = moduleType.Value };
                <TaskModuleDataFormSection TaskModalContext="TaskModalContext" TaskModuleContext="moduleContext" />
            }
        }
        break;

    case ParameterType.BOOL:
        <Validation>
            <Field ColumnSize="@(TaskModuleParamContext.ParamFlags?.DisplayActions == true || TaskModuleParamContext.ListFlags?.DisplayActions == true ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                @if (!(TaskModuleParamContext.ParamFlags?.SkipLabel == true) && !(TaskModuleParamContext.ListFlags?.SkipListLabel == true))
                {
                    <FieldLabel For="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))" RequiredIndicator="@(TaskModuleParamContext.ParamOption.Required == true)">
                        @TaskModuleParamContext.ParamName
                    </FieldLabel>
                }

                <Check TValue="bool?"
                       ElementId="@(GetElementIdByOperation(TaskModuleParamContext.ParamOption.Key))"
                       Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                       @bind-Checked="@TaskModuleParamContext.ParamValue!.Value!.BoolValue">
                    <Feedback>
                        <ValidationError Multiline="true" />
                    </Feedback>
                </Check>
            </Field>
        </Validation>
        break;
}

@code {
    [Parameter]
    public TaskModalContext TaskModalContext { get; set; } = null!;

    [Parameter]
    public TaskModuleContext TaskModuleContext { get; set; } = null!;

    [Parameter]
    public TaskModuleParamContext TaskModuleParamContext { get; set; } = null!;

    private string? timeStringValue;
    private InputMask? timeInputMask;
    private Validation? timeValidationComponent;

    private void ValidateTimeParameter(ValidatorEventArgs args) => ParameterTimeValidator.ValidateTimeParameter(args, TaskModuleParamContext.ParamValue!, resourceHandler);

    protected override async Task OnParametersSetAsync()
    {
        if (DynamicParamUtils.GetParameterType(TaskModuleParamContext.ParamOption.Type) == ParameterType.TIME)
        {
            timeStringValue = ParameterTimeHelper.ConvertSecondsToTimeString(TaskModuleParamContext.ParamValue!.Value?.IntValue);
        }
        await base.OnParametersSetAsync();
    }

    private string GetTimeInputPlaceholder()
    {
        if (TaskModuleParamContext.ParamOption.Default?.IntValue is not null && TaskModuleParamContext.ParamOption.Default.IntValue.Value != -1)
        {
            return ParameterTimeHelper.ConvertSecondsToTimeString(TaskModuleParamContext.ParamOption.Default.IntValue) ?? string.Empty;
        }
        return string.Empty;
    }

    private int? ConvertTimeStringToSeconds(string? timeString)
    {
        const string maskPattern = "__:__:__";
        if (string.IsNullOrWhiteSpace(timeString) || timeString == maskPattern)
        {
            return null;
        }

        var parts = timeString.Split(':');
        if (parts.Length == 3)
        {
            if (int.TryParse(parts[0], NumberStyles.Integer, CultureInfo.InvariantCulture, out int hours) &&
                int.TryParse(parts[1], NumberStyles.Integer, CultureInfo.InvariantCulture, out int minutes) &&
                int.TryParse(parts[2], NumberStyles.Integer, CultureInfo.InvariantCulture, out int seconds))
            {
                if (hours >= 0 && hours <= 99 && minutes >= 0 && minutes <= 59 && seconds >= 0 && seconds <= 59)
                {
                    return (hours * 3600) + (minutes * 60) + seconds;
                }
            }
        }
        return -1;
    }

    private async Task OnStringEnumValueChanged(string? newValue)
    {
        if (TaskModuleParamContext.ParamValue?.Value?.EnumValue is not null)
        {
            TaskModuleParamContext.ParamValue.Value.EnumValue.StringValue = newValue;
        }
        await RefreshFlags();
    }


    private async Task OnTimeStringChanged(string? newValue)
    {
        timeStringValue = newValue;
        if (TaskModuleParamContext.ParamValue?.Value is not null)
        {
            TaskModuleParamContext.ParamValue.Value.IntValue = ConvertTimeStringToSeconds(timeStringValue);
        }
        await RefreshFlags();
    }

    private async Task RefreshFlags()
    {
        if (TaskModuleParamContext.ParamFlags is not null)
        {
            var flags = taskManipulationService.GetParamFlags(TaskModuleContext.Module, TaskModuleParamContext.ParamOption, TaskModuleParamContext.ParamValue!);
            mapper.Map(flags, TaskModuleParamContext.ParamFlags);
        }
        else if (TaskModuleParamContext.ListFlags is not null)
        {
            var listFlags = taskManipulationService.GetListParamFlags(TaskModuleParamContext.ParamOption, TaskModuleParamContext.ParamValue!);
            mapper.Map(listFlags, TaskModuleParamContext.ListFlags);
        }
        await uiService.CallRequestRefreshAsync();
    }

    private string GetElementIdByOperation(string elementBase) => VisualisationHelper.GetElementIdByOperation<TaskModuleParameterDto>(elementBase, TaskModalContext.Operation, $"{TaskModalContext.Task.ID.ToString()}_{TaskModuleParamContext.ParamID.ToString()}");
}
