@inject IResourceHandler resourceHandler
@inject ITaskManipulationService taskManipulationService
@inject IUIService uiService

<Row Margin="Margin.Is4.FromBottom">
    <Container Fluid>
        <FormSectionHeader DisplayText="@TaskModuleContext.ModuleName" />
    </Container>

    <Divider Class="divider-section bg-custom-light" Shadow="Shadow.Small" Margin="Margin.Is0.FromTop.Is1.FromBottom" />

    <Column ColumnSize="ColumnSize.Is12" Padding="Padding.Is3.FromTop">
        <Fields>

            <Validation>
                <Field ColumnSize="@(!string.IsNullOrWhiteSpace(TaskModuleContext.ModuleData?.Description) ? ColumnSize.Is10.Is11.OnFullHD : ColumnSize.IsFull)">
                    <FieldLabel For="@(GetElementIdByOperation(nameof(TaskModuleDto.ShortName)))" RequiredIndicator>
                        @(resourceHandler.GetResource(AttributeExtensions.GetResourceFieldValue<TaskModuleDto>(nameof(TaskModuleDto.ShortName), PropertyDisplayResourceType.FIELD)))
                    </FieldLabel>
                    <Select TValue="string"
                            Disabled="@(TaskModalContext.TaskMetadata.InitializationInProgres)"
                            SelectedValue="@TaskModuleContext.Module.ShortName"
                            SelectedValueExpression="@(() => TaskModuleContext.Module.ShortName)"
                            SelectedValueChanged="@(async (value) => await SelectionChanged(value))"
                            ElementId="@(GetElementIdByOperation(nameof(TaskModuleDto.ShortName)))">
                        <ChildContent>
                            <SelectItem Value="string.Empty">
                                @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.Empty}"))
                            </SelectItem>
                            @foreach (var moduleType in TaskModuleContext.ModuleOptions)
                            {
                                <SelectItem Value="@(moduleType.ShortName)">
                                    @(moduleType.LongName)
                                </SelectItem>
                            }
                        </ChildContent>
                        <Feedback>
                            <ValidationError Multiline="true" />
                        </Feedback>
                    </Select>
                </Field>
            </Validation>

            @if (!string.IsNullOrWhiteSpace(TaskModuleContext.ModuleData?.Description))
            {
                <Field ColumnSize="ColumnSize.Is2.Is1.OnFullHD" TextAlignment="TextAlignment.Center" Class="align-self-center" Padding="Padding.Is0.FromEnd.Is0.FromStart" Margin="Margin.Is2.FromTop">
                    <FieldLabel>
                        @(resourceHandler.GetResource($"{UIConstants.Data}.{UIConstants.Generic}.{UIValueConstants.Actions}"))
                    </FieldLabel>
                    <Div>
                        <Tooltip Multiline="true" Text="@(TaskModuleContext.ModuleData?.Description)" Display="Display.InlineBlock" Padding="Padding.Is1.FromEnd">
                            <Icon Class="action-icon-sm action-icon-info" Name="IconName.InfoCircle" IconSize="IconSize.Default" IconStyle="IconStyle.Solid" />
                        </Tooltip>
                    </Div>
                </Field>
            }

        </Fields>

        <Column ColumnSize="ColumnSize.IsFull">
            <Container Fluid>
                @if (!string.IsNullOrWhiteSpace(TaskModuleContext.Module.ShortName))
                {
                    <TaskModuleParamsFormSection TaskModalContext="TaskModalContext" TaskModuleContext="TaskModuleContext" />
                }
            </Container>
        </Column>
    </Column>
</Row>

@code {
    [Parameter]
    public TaskModalContext TaskModalContext { get; set; } = null!;

    [Parameter]
    public TaskModuleContext TaskModuleContext { get; set; } = null!;

    private Guid ModuleID = Guid.NewGuid();
    private string GetElementIdByOperation(string elementBase) => VisualisationHelper.GetElementIdByOperation<TaskModuleDto>(elementBase, TaskModalContext.Operation, $"{TaskModalContext.Task.ID.ToString()}_{ModuleID.ToString()}");

    private async Task SelectionChanged(string value)
    {
        var sourceModule = TaskModuleContext.ModuleOptions.FirstOrDefault(x => x.ShortName == value);
        taskManipulationService.SwapSelectedModule(sourceModule, TaskModuleContext.Module);
        await uiService.CallRequestRefreshAsync();
    }
}
