@inject IMapper mapper
@inject IUIService uiService
@inject ITaskManipulationService taskManipulationService
@inject ITaskApiService taskApiService
@inject IResourceHandler resourceHandler

<Modal @ref="@Modal" @bind-Visible="@isModalVisible" Closing="OnModalClosing" Class="modal-dialog-extrawide" Border="Border.Rounded">
    @if (isModalVisible)
    {
        @if (TaskMetadata.ReloadInProgress)
        {
            <BackgroundLoadSpinner TextColor="TextColor.White" TextSize="TextSize.Large" />
        }

        <ModalContent Centered Shadow="Shadow.Small">
            @if (isTaskLoading)
            {
                <ContentLoadSpinner />
            }
            else
            {
                <CascadingValue Value="Task">
                    <CascadingValue Value="TaskMetadata">
                        <CascadingValue Value="Modal">

                            <GenericModalHeader DisplayText="@($"{resourceHandler.GetResource($"{UIConstants.Base}.{UIConstants.Generic}.{UIActionConstants.Overview}")} - {Task.Config.Name}")" />

                            <ModalBody Padding="Padding.Is0">
                                <Container Fluid Height="Height.Is100">
                                    <Row Height="Height.Is100">
                                        <Column ColumnSize="ColumnSize.Is3.OnWidescreen" TextAlignment="TextAlignment.Start" Class="overview-dialog-column" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnEnd">
                                            <TaskSubitemsDataViewSection />
                                        </Column>
                                        <Column ColumnSize="ColumnSize.Is6.OnWidescreen" Class="overview-dialog-column" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnStart.Is1.OnEnd">
                                            <TaskMessagesViewSection />
                                        </Column>
                                        <Column ColumnSize="ColumnSize.Is3.OnWidescreen" TextAlignment="TextAlignment.Start" Class="overview-dialog-column" Height="Height.Is100" Display="Display.Flex" Flex="Flex.Column" Overflow="Overflow.Auto" Border="Border.Is1.OnStart">
                                            <TaskInfoDataViewSection />
                                        </Column>
                                    </Row>

                                </Container>
                            </ModalBody>

                            <TaskOverviewModalFooter />

                        </CascadingValue>
                    </CascadingValue>
                </CascadingValue>
            }
        </ModalContent>
    }

</Modal>

@code {
    [CascadingParameter]
    public ObservableCollection<TaskInfoDto> Tasks { get; set; } = [];

    [CascadingParameter]
    public TaskInfoDto TaskInfo { get; set; } = new();

    private bool isTaskLoading = false;
    private bool isModalVisible = false;
    private CancellationTokenSource? cancellationTokenSource;

    private TaskDto Task;
    private Modal Modal;
    private TaskViewMetadataDto TaskMetadata;

    public TaskOverviewModal()
    {
        Task = new();
        TaskMetadata = new(Task);

        Modal = new Modal();
    }

    private async Task OnModalClosing(ModalClosingEventArgs e)
    {
        if (cancellationTokenSource is not null)
        {
            await cancellationTokenSource!.CancelAsync();
        }
        cancellationTokenSource = new CancellationTokenSource();
    }

    private async Task ModalShow()
    {
        isModalVisible = true;
        await Modal.Show();
    }

    public async Task Show()
    {
        isTaskLoading = true;
        await ModalShow();

        var opened = await taskApiService.LoadTask(TaskInfo.ID);
        if (opened is not null)
        {
            mapper.Map(opened, Task);
        }

        cancellationTokenSource = new CancellationTokenSource();
        _ = StartPeriodicTaskInfoRefreshCall(cancellationTokenSource.Token);
        isTaskLoading = false;
    }

    private async Task StartPeriodicTaskInfoRefreshCall(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                TaskMetadata.ReloadInProgress = true;
                uiService.CallRequestRefresh();

                var taskInfoNew = await taskApiService.LoadTask(TaskInfo.ID);
                if (taskInfoNew is not null)
                {
                    mapper.Map(taskInfoNew, Task);
                }

                TaskMetadata.ReloadInProgress = false;
                uiService.CallRequestRefresh();
                await System.Threading.Tasks.Task.Delay(TimeSpan.FromSeconds(5), cancellationToken);
            }
        }
        catch (TaskCanceledException ex)
        {
            await Console.Out.WriteLineAsync(ex.Message);
        }
    }
}